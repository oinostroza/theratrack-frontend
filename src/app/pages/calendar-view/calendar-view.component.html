<div class="max-w-4xl mx-auto p-4">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-3xl font-extrabold text-indigo-700 mb-1">Calendario de Sesiones</h1>
    <p class="text-gray-500 text-base">Visualiza todas las sesiones registradas por fecha. Puedes explorar rápidamente por mes o año.</p>
  </div>

  <!-- Selector de año -->
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center space-x-2">
      <label for="year-select" class="text-sm text-gray-600 font-medium">Año:</label>
      <select id="year-select" [(ngModel)]="selectedYear" (change)="onYearChange()"
        class="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-gray-700 focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition shadow-sm">
        <option *ngFor="let year of years" [value]="year">{{ year }}</option>
      </select>
    </div>
    <div class="flex items-center space-x-2">
      <button (click)="prevMonth()" class="p-2 rounded-full hover:bg-gray-100 transition">
        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <h2 class="text-xl font-bold text-gray-800 select-none">{{ monthLabel | titlecase }}</h2>
      <button (click)="nextMonth()" class="p-2 rounded-full hover:bg-gray-100 transition">
        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Calendario -->
  <div class="bg-white rounded-2xl shadow-lg p-4 border border-gray-100">
    <div class="grid grid-cols-7 gap-2 mb-2 text-center text-gray-500 font-semibold">
      <div>Lun</div>
      <div>Mar</div>
      <div>Mié</div>
      <div>Jue</div>
      <div>Vie</div>
      <div>Sáb</div>
      <div>Dom</div>
    </div>
    <div class="grid grid-cols-7 gap-3">
      <ng-container *ngFor="let week of weeks">
        <ng-container *ngFor="let day of week">
          <div
            (click)="openDayModal(day)"
            class="relative group cursor-pointer select-none flex flex-col items-center justify-center h-20 rounded-xl border border-gray-200 bg-white transition transform duration-200
              {{ day.isCurrentMonth ? '' : 'bg-gray-50 text-gray-300' }}
              {{ day.isToday ? 'ring-2 ring-indigo-400 scale-105 z-10' : '' }}
              {{ day.sessionCount > 0 && day.isCurrentMonth ? 'bg-indigo-50 border-indigo-200 shadow-md hover:scale-105 hover:shadow-lg' : 'hover:bg-gray-100' }}"
            [ngClass]="{'pointer-events-none opacity-50': !day.isCurrentMonth}"
          >
            <span class="text-lg font-semibold mb-1 transition-colors duration-200"
              [ngClass]="{
                'text-indigo-600': day.isToday,
                'text-gray-800': day.isCurrentMonth && !day.isToday,
                'text-gray-400': !day.isCurrentMonth
              }"
            >{{ day.day }}</span>
            <div *ngIf="day.sessionCount > 0" class="flex items-center space-x-1 mt-1 animate-fadeIn">
              <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke-width="2" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h4v4" />
              </svg>
              <span class="text-xs font-medium text-indigo-700">{{ day.sessionCount }}</span>
            </div>
            <div *ngIf="day.isToday" class="absolute top-2 right-2 animate-pulse">
              <span class="inline-block w-2 h-2 rounded-full bg-indigo-500"></span>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </div>
  </div>

  <!-- Modal de sesiones del día -->
  <div *ngIf="showDayModal && selectedDay" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 backdrop-blur-sm animate-fadeIn">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6 relative animate-modalIn">
      <button (click)="closeDayModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <h3 class="text-xl font-bold text-gray-800 mb-2">Sesiones del {{ selectedDay.date | date:'dd/MM/yyyy' }}</h3>
      <div *ngIf="selectedDay.sessions.length === 0" class="text-gray-500 text-center py-8">
        No hay sesiones agendadas para este día.
      </div>
      <div *ngIf="selectedDay.sessions.length > 0" class="space-y-4 max-h-80 overflow-y-auto">
        <div *ngFor="let session of selectedDay.sessions" class="bg-gray-50 rounded-lg p-4 shadow hover:bg-indigo-50 transition">
          <div class="flex items-center justify-between mb-1">
            <span class="font-semibold text-gray-700">{{ session.patient?.fullName || 'Paciente' }}</span>
            <span class="text-xs text-gray-500">{{ session.horaInicio }} - {{ session.horaFin }}</span>
          </div>
          <div class="text-sm text-gray-600 mb-1">{{ session.tipoSesion | titlecase }}</div>
          <div class="text-xs text-gray-400 mb-1">Monto: ${{ session.monto | number:'1.0-0' }}</div>
          <div class="text-xs text-gray-500 mb-1">Email: {{ session.patient?.email || 'Sin email' }}</div>
          <div class="text-xs text-gray-500 mb-1">Contacto: {{ session.patient?.contactInfo || 'Sin contacto' }}</div>
          <div class="mt-2">
            <div *ngIf="loadingTranscriptions" class="flex items-center text-xs text-gray-400">
              <svg class="w-4 h-4 mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Cargando transcripción...
            </div>
            <div *ngIf="!loadingTranscriptions">
              <div *ngIf="session.transcription">
                <div class="text-xs text-indigo-600 font-semibold mb-1">Transcripción:</div>
                <div class="bg-white rounded p-2 text-xs text-gray-700 border border-indigo-100 whitespace-pre-line max-h-32 overflow-y-auto">{{ session.transcription.content }}</div>
              </div>
              <div *ngIf="!session.transcription" class="text-xs text-gray-400">Sin transcripción</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer fijo -->
  <footer class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-inner py-3 z-40">
    <div class="max-w-4xl mx-auto px-4 text-center text-sm text-gray-500">
      Recuerda registrar las sesiones una vez finalizadas para mantener este calendario actualizado.
    </div>
  </footer>
</div> 